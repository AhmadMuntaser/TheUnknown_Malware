# TheUnknown_Malware


1. Executive Summary
Using the Remnux and windows 10 to provide the malware suitable environment to be executed 
Setting Remnux to act as DNS to reply for each query send by the malware and provide him with the html code and any file it downloads it from the internet, therefor the malware thinks it have a real internet connection.



2. Identification

	2.1 Unknown_Malware.exe, 52KB, PE 
	2.2 sha-1 hash: 28781551D4B8FC8700672FE2320945B56155AFF2

3. Capabilities

This malware is an information stealer malware that’s obtain the victim Device-Name and the private Ip address and send them encrypted using Caesar cipher to an http://www.example.com /post-handler. through the post method.  

4. Dependencies

Provided internet connection to the malware should be enough for the malware to function.


5.	Setting up the lab:


We start off by installing FlareVM on a Windows 10 machine

You can download it from https://github.com/mandiant/flare-vm

![image](https://user-images.githubusercontent.com/103259604/213680418-5552b094-8865-4ce0-aeca-e8d0a3d1e215.png)


Followed up by Installing Remnux Machine

You can download the remnux machine from https://docs.remnux.org/install-distro/get-virtual-appliance

![image](https://user-images.githubusercontent.com/103259604/213680450-e726f7b8-4bdd-4866-a2f8-bd452fbbbbdc.png)


By installing the above machines we have successfully created our safe environment for the analysis.

To keep up we have to change the configurations in the Oracle-VM as follows:

![image](https://user-images.githubusercontent.com/103259604/213680762-fee4a5c2-90ce-4b99-ad64-f27ab7d2045a.png)

![image](https://user-images.githubusercontent.com/103259604/213680777-7050d029-b4a8-4bd7-97b1-e3d87a1f39b8.png)


6.	Setting up the network of the Windows Machine

We start setting up the network of the windows machine by going through the network settings in the control panel and by selecting properties of our used network adapter and by setting the IP address manually. As shown below

![image](https://user-images.githubusercontent.com/103259604/213680877-79d3acb8-34cc-46fa-80fe-9a8edf57f332.png)


7.	Testing Phase:


In this step we are testing the inetsim, by executing the following command on the remnux machine:
sudo inetsim


![image](https://user-images.githubusercontent.com/103259604/213680996-68259fad-a23c-40f7-b2e0-243df0c64ca9.png)


After executing the inetsim command we figured out that all the traffic on the windows machine will be redirected to the remnux machine. Just as shown below when we try to access the internet.

![image](https://user-images.githubusercontent.com/103259604/213681027-351cc0a8-e18a-4bb1-b64c-9cfb6c863626.png)


8.	Analysis:

A.	Static Analysis:

Starting the static analysis, which means analyzing the malware without execution.
We start the static analysis by using PEStudio, to see that the malware that we are analyzing is a windows executable and the hash file that it is using. Although the hash file will not be available through the internet, due to it being a new malware that is hand crafted by Dr. Haitham. As shown in the two following screenshots.
MZ means it’s a windows executable.



9. Host Indecators 

	9.1 Top level components
    
	Floss, CFF, ProcMon, and PEStudio. In addition to the W10 virtual machine with the malware analysis flavor and Remnux.
    
	9.2 Execution points of entry
    
	Using the PEStudio to get a first observation of the file a 32-bit executable file that has 	been written in Microsoft visual basic, unpacked due to the slightly deference between 	the raw size and the virtual size. Then by using Floss to get the hardcoded strings in this malware.
    
	9.3 Embedded strings
    
	By using Floss to get any 4 character or above we found some interesting strings:




![image](https://user-images.githubusercontent.com/103259604/213681302-b125d18a-959a-4e97-81aa-8dd0c1dfff0e.png)

![image](https://user-images.githubusercontent.com/103259604/213681329-e12f1e62-a8d3-465b-ad0d-0c0bc9b93333.png)


After we entered the command strings, we received the following output as shown in the below screenshots.
This output shows the string of the malware program, they give us indications about what the malware is doing.


![image](https://user-images.githubusercontent.com/103259604/213681377-f61d40a4-989d-41ca-8fcd-86ad8ab8812a.png)


![image](https://user-images.githubusercontent.com/103259604/213681419-6f1f4513-8eab-4608-b6f3-6b8509d0f556.png)


![image](https://user-images.githubusercontent.com/103259604/213681438-c1ac38a5-134f-4d5b-ac87-c5a3e171135f.png)

We were able to analyze some of the above strings, which grabbed our attention such as:
Psut.dll is missing!  This message pops up as soon as you execute the malware, which is there to just confuse the user.
No internet, No Game  This message pops up if you try and execute the malware while not connected to the internet.
Updator.exe  seems interesting here. We still have no clue what this does yet.
CaesarCipher  seems interesting, why would an application have CaesarCipher string in it? Soon we will figure out.
Example.com  seems interesting as well.


9.4 File contents

	What will be created and what it will contains.
    
		5.5.1 files created/deployed on the system
        
		By running the malware and using the ProcMon to detect the behavior of the malware and analyze it, the malware is downloading a file called a updator.exe in the windows directory. This file will not be installed if there is not internet connectivity in the environment. 
 
 
 ![image](https://user-images.githubusercontent.com/103259604/224703686-1a209615-f486-426a-8a30-1eaab3227c3b.png)


![image](https://user-images.githubusercontent.com/103259604/224703693-4829ad2f-798c-4e5f-899d-4e9683b6b21e.png)


![image](https://user-images.githubusercontent.com/103259604/224703729-51991c44-0374-496c-8f5f-0efe96a7a24d.png)

 
 
 
 
This updator.exe will download another file called hacked.txt, its like a process inside another process-injected process- this hacked.txt file contains some encrypted or decoded strings. This file is created under the Users directory.



B.	Dynamic Analysis:

Starting the dynamic analysis means analyzing the malware after its execution. 
We start our dynamic analysis by checking the Process Monitor Filter (PMF).

In this stage of investigation, we analyze the network traffic generated by the malware. 

	6.1 Network traffic analysis	
	After running the application with no internet connection, the malware did not 	work and a message popped out.


![image](https://user-images.githubusercontent.com/103259604/224701319-fd628f32-25aa-4977-9663-c6710248abc8.png)

After setting the DNS records for google.com and example.com(the URLs in the strings we found) in the Inetsim to deceive the malware that it works in a real environment a request to google.com is sent to test the connectivity.


![image](https://user-images.githubusercontent.com/103259604/224701361-c565a75c-cab1-464d-8382-07b0eaeef5de.png)


![image](https://user-images.githubusercontent.com/103259604/224701382-f8ed6db5-b609-4b65-9ea9-f768af3b9715.png)


It appears that the malware is using Microsoft crypto API to encrypt something, we assumed it is the API that is responsible for encrypting the victim information in the hacked.txt.

![image](https://user-images.githubusercontent.com/103259604/224701430-1fd0d6b1-078e-4f85-96fa-b942718c5a5d.png)


![image](https://user-images.githubusercontent.com/103259604/224701444-bd8decb4-697e-4159-9faf-3597ba104699.png)

The malware then tries to communicate with the example.com through POST request to send the hacked.txt file.


![image](https://user-images.githubusercontent.com/103259604/224701489-0e4e1617-283e-4e8a-8c1a-d1bc6b238851.png)


![image](https://user-images.githubusercontent.com/103259604/224701514-651b49ff-6ed1-45b7-96fa-539579fd69c3.png)





![image](https://user-images.githubusercontent.com/103259604/213681562-f700ac0d-9756-4d1f-9a5d-2a858c52541f.png)


The Following Screenshots are network indicators that are showing us that the malware is trying to create a network connection to Microsoft.com (SC1) & Google.com (SC2) as well.


![image](https://user-images.githubusercontent.com/103259604/213681613-fcc08b28-9494-4997-85e6-f9f0cc65e49e.png)

![image](https://user-images.githubusercontent.com/103259604/213681673-e904ace9-f647-4400-ac0f-89d7d993820b.png)

We found something interesting while analyzing the network to find out that there is a GET that is trying to download something. Although we had no internet connection at that point yet.

![image](https://user-images.githubusercontent.com/103259604/213681699-c6febf8e-b126-4d6d-8fc7-b476ff277aa1.png)

The following screenshot shows the following that had the respond stream (next TCP stream in the wireshark for GET – download).


![image](https://user-images.githubusercontent.com/103259604/213681743-46e7a0a1-23a6-4ceb-8702-4d09f103f7b1.png)



And we can see this POST request to /post_handler
After connecting to the internet we went back to the Wireshark to complete our network analysis and we found out that the malware is trying to download something on our device.


![image](https://user-images.githubusercontent.com/103259604/213681781-faa16c64-5194-4933-b243-bd2de088a52c.png)

The following screenshot assures us that the malware is trying to have a connection on google.com


![image](https://user-images.githubusercontent.com/103259604/213681832-2e24df08-05f9-46bf-a9c3-8d9de1e756a9.png)




Host indicator:
We found out after further on the analysis that when connected to the internet the malware creates a new text folder in the C:\Users Directory that has an encrypted paragraph in it as shown below.

![image](https://user-images.githubusercontent.com/103259604/213681864-ec168d16-fc28-41ce-bbaa-9ff5f63c90c6.png)

It seems that the malware encrypts using caser cipher and here is the decryption form of Hacked.txt as shown below.

![image](https://user-images.githubusercontent.com/103259604/213681888-98153fe7-d477-4ba9-92ee-37d828e0f642.png)


After analyzing seems like this malware is trying to steal the device’s information, based on the folder it created that had encrypted paragraph with Creaser Cipher algorithm, so we decided to decrypt the content of the text folder to find out that the decryption is our device’s name as shown below.


![image](https://user-images.githubusercontent.com/103259604/213681939-5a3c71c7-b18d-4d73-bff7-af36e2b872ec.png)


After we followed the process of the executable (updator.exe) on Process Monitor, we found out that it is the main cause of the creation of the text folder (hacked.txt) and it is the process that is responsible of stealing the device’s information. As shown below.

![image](https://user-images.githubusercontent.com/103259604/213681964-875fd1de-2ee0-4dc8-bef8-de7a6723698b.png)


10.	YARA Rules:

        rule unknown_malware 
        {
            meta:
            auther="Ahmad muntaser"
            malware_auther = "dr.haith al ani"
            description = "This Malware steals device information (Name & private ip) and then send it to network through www.example.com"

            strings: 

                $mz = { 4D 5A }
                $z1 = "http://www.example.com/post_handler" ascii wide 
                $z2 = "POST" ascii wide 
                $z3 = "text=" ascii wide 
                $x1 = "CaesarCipher"
                $x2 = "updator.exe" ascii wide 
                $x3= "Hacked.txt" ascii wide 

            condition: 
                ($x1 and $x2 and $x3) or ($z3 and $z2 and $z1) and $mz
        }


here is the Yara rules to detect both web based and host based behaviors, looking for the example.com path sent through POST request, the malicious files created used the CaesarCipher. Since we are interested in the executable files we only look for them.






11. Conclusion

This unkown_malware is an executable file is responsible for creating a file called updator.exe that is responsible for grabbing the information of the victim device and encrypting them using the Caesar cipher and stores them in a file called hacked.txt then send this data to the example.com. the malware tries to deceive the victim by popping a message called PSUT.dll is messing but its not a really important because it is only care for network connectivity. 












